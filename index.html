<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero Económico Estable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background-color: #f3f4f6; }
        /* Corrección crítica: asegurar que los contenedores de gráficos no desborden */
        .chart-container {
            position: relative;
            width: 100%;
            overflow: hidden; /* Evita que el gráfico empuje el layout */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <header class="bg-white rounded-lg shadow-sm p-6 mb-6 flex flex-col md:flex-row justify-between items-center border border-gray-200">
            <div class="mb-4 md:mb-0 text-center md:text-left">
                <h1 class="text-2xl font-bold text-gray-800">Tablero de Inteligencia Económica</h1>
                <p class="text-gray-500 text-sm">Monitor de actividad empresarial DENUE</p>
            </div>
            <div class="bg-blue-600 text-white px-5 py-2 rounded-full font-bold shadow-md">
                9,761 Unidades
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                <div class="text-gray-400 text-xs font-bold uppercase">Giro Principal</div>
                <div class="text-xl font-bold text-gray-800">Abarrotes</div>
                <div class="text-blue-600 text-xs mt-1">17% del mercado</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                <div class="text-gray-400 text-xs font-bold uppercase">Tamaño</div>
                <div class="text-xl font-bold text-gray-800">Micro (0-5)</div>
                <div class="text-green-600 text-xs mt-1">88.4% predominancia</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-purple-500">
                <div class="text-gray-400 text-xs font-bold uppercase">Municipio</div>
                <div class="text-xl font-bold text-gray-800">Tuxtla Gtz</div>
                <div class="text-purple-600 text-xs mt-1">Zona Centro</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-orange-500">
                <div class="text-gray-400 text-xs font-bold uppercase">Actualización</div>
                <div class="text-xl font-bold text-gray-800">2024</div>
                <div class="text-orange-600 text-xs mt-1">Pico de registros</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="bg-white p-5 rounded-lg shadow-sm lg:col-span-2 min-w-0">
                <h3 class="font-bold text-gray-700 mb-4">Actividades Económicas (Top 10)</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="activitiesChart"></canvas>
                </div>
            </div>
            
            <div class="bg-white p-5 rounded-lg shadow-sm min-w-0">
                <h3 class="font-bold text-gray-700 mb-4">Tamaño de Negocios</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="sizeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white p-5 rounded-lg shadow-sm lg:col-span-2 min-w-0">
                <h3 class="font-bold text-gray-700 mb-4">Distribución Geográfica (Muestra)</h3>
                <div id="map" style="height: 400px; width: 100%; border-radius: 0.5rem; z-index: 1;"></div>
            </div>
            
            <div class="bg-white p-5 rounded-lg shadow-sm min-w-0">
                <h3 class="font-bold text-gray-700 mb-4">Histórico</h3>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="yearChart"></canvas>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-gray-400 text-xs">
            Datos procesados del INEGI DENUE
        </footer>
    </div>

    <script>
        // --- DATOS ESTÁTICOS ---
        const data = {
            activities: {"Abarrotes": 1656, "Belleza": 385, "Fruterías": 352, "Religiosas": 294, "Mecánica": 264, "Antojitos": 230, "Tacos/Tortas": 221, "Carne Aves": 181, "Comida Rápida": 176, "Alimentos": 175},
            sizes: {"0-5 personas": 8629, "6-10 personas": 577, "11-30 personas": 379, "31-50 personas": 72, "51+ personas": 104},
            years: {"2010": 1974, "2014": 1092, "2019": 2192, "2023": 79, "2024": 3907, "2025": 262},
            points: [
                {lat: 16.751, lng: -93.115, title: "Comercio"}, {lat: 16.737, lng: -93.045, title: "Autopartes"},
                {lat: 16.730, lng: -93.038, title: "Alimentos"}, {lat: 16.735, lng: -93.111, title: "Carnicería"},
                {lat: 16.751, lng: -93.056, title: "Depósito"}, {lat: 16.748, lng: -93.044, title: "Iglesia"},
                {lat: 16.737, lng: -93.103, title: "Llantas"}, {lat: 16.744, lng: -93.081, title: "Escuela"},
                {lat: 16.733, lng: -93.066, title: "Capilla"}, {lat: 16.748, lng: -93.089, title: "Automotriz"},
                {lat: 16.750, lng: -93.096, title: "Farmacia"}, {lat: 16.745, lng: -93.075, title: "Burger King"},
                {lat: 16.722, lng: -93.107, title: "Hospital"}, {lat: 16.753, lng: -93.064, title: "Abarrotes"},
                {lat: 16.742, lng: -93.043, title: "Regalos"}, {lat: 16.740, lng: -93.093, title: "Empeño"},
                {lat: 16.729, lng: -93.039, title: "Taller"}, {lat: 16.750, lng: -93.093, title: "Banco"},
                {lat: 16.738, lng: -93.082, title: "Comedor"}, {lat: 16.742, lng: -93.061, title: "Papelería"}
            ]
        };

        // --- CONFIGURACIÓN SEGURA DE CHART.JS ---
        // Desactivar animaciones de redimensionamiento excesivas
        Chart.defaults.maintainAspectRatio = false; 
        Chart.defaults.responsive = true;
        Chart.defaults.font.family = '-apple-system, system-ui, sans-serif';

        // 1. Gráfico de Barras
        new Chart(document.getElementById('activitiesChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(data.activities),
                datasets: [{
                    label: 'Negocios',
                    data: Object.values(data.activities),
                    backgroundColor: 'rgba(37, 99, 235, 0.7)',
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y', // Barras horizontales
                plugins: { legend: { display: false } }
            }
        });

        // 2. Gráfico de Dona
        new Chart(document.getElementById('sizeChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(data.sizes),
                datasets: [{
                    data: Object.values(data.sizes),
                    backgroundColor: ['#10B981', '#34D399', '#6EE7B7', '#A7F3D0', '#D1FAE5'],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '70%',
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }
            }
        });

        // 3. Gráfico de Línea
        const relevantYears = Object.entries(data.years).filter(([y, v]) => v > 50);
        new Chart(document.getElementById('yearChart'), {
            type: 'line',
            data: {
                labels: relevantYears.map(k => k[0]),
                datasets: [{
                    label: 'Nuevos Registros',
                    data: relevantYears.map(k => k[1]),
                    borderColor: '#f97316',
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });

        // --- MAPA ---
        // Inicializar mapa asegurando que el contenedor existe
        const map = L.map('map').setView([16.75, -93.10], 13);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'OpenStreetMap'
        }).addTo(map);

        // Icono simple
        const icon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41]
        });

        data.points.forEach(p => {
            L.marker([p.lat, p.lng], {icon: icon})
             .bindPopup(`<b style="font-size:14px">${p.title}</b>`)
             .addTo(map);
        });

        // Forzar recalculo del tamaño del mapa después de cargar para evitar errores de gris
        setTimeout(() => { map.invalidateSize(); }, 500);

    </script>
</body>
</html>